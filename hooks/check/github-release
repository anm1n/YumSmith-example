#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: $0 -p <project directory>"
  exit 1
}

# Parse arguments
while getopts ":p:" opt; do
  case $opt in
  p) project_dir="$OPTARG" ;;
  *) usage ;;
  esac
done

if [[ -z "${project_dir:-}" ]]; then
  usage
fi

# Check configuration file
config_file=""
if [[ -f "$project_dir/config.yaml" ]]; then
  config_file="$project_dir/config.yaml"
elif [[ -f "$project_dir/config.yml" ]]; then
  config_file="$project_dir/config.yml"
else
  echo "Error: config.yaml or config.yml not found in $project_dir" >&2
  exit 1
fi

# Iterate over the source list
count=$(yq '.source | length' "$config_file")
tmp_config=$(mktemp)
cp "$config_file" "$tmp_config"

for ((i = 0; i < count; i++)); do
  url=$(yq -r ".source[$i].url" "$tmp_config")

  # Check if it is a GitHub URL
  if [[ "$url" =~ ^https://github\.com/([^/]+)/([^/]+) ]]; then
    owner="${BASH_REMATCH[1]}"
    repo="${BASH_REMATCH[2]}"

    # Get the latest release information
    release_json=$(gh api "repos/${owner}/${repo}/releases/latest")

    # Extract version number (remove leading v)
    raw_tag=$(echo "$release_json" | jq -r '.tag_name')
    version="${raw_tag#v}"

    regex=$(yq -r ".source[$i].regex" "$tmp_config")

    if [[ "$regex" != "null" && -n "$regex" ]]; then
      # Match release asset using regex
      asset_url=$(echo "$release_json" | jq -r --arg re "$regex" '.assets[] | select(.name | test($re)) | .browser_download_url' | head -n1)
    else
      # Default to using the automatically packaged source tarball
      asset_url="https://github.com/${owner}/${repo}/archive/refs/tags/${raw_tag}.tar.gz"
    fi

    if [[ -z "$asset_url" ]]; then
      echo "Warning: No matching file found ($owner/$repo)" >&2
      continue
    fi

    # Download and calculate sha256
    tmpfile=$(mktemp)
    curl -sL "$asset_url" -o "$tmpfile"
    sha256=$(sha256sum "$tmpfile" | awk '{print $1}')
    rm -f "$tmpfile"

    echo -e "$project_dir\tsource[${i}]\t$version\t$asset_url\t$sha256" | column -t -s $'\t'

    # Update configuration file
    yq -i ".source[$i].url = \"$asset_url\"" "$tmp_config"
    yq -i ".source[$i].sha256sum = \"$sha256\"" "$tmp_config"
  fi
done

# Overwrite the original configuration file
mv "$tmp_config" "$config_file"

echo "Configuration file updated: $config_file"

project_name=$(basename "$project_dir")
specfile=${project_dir}/${project_name}.spec

if [ -e "$specfile" ]; then
  # Replace only the pure version number after 'Version:', keeping any trailing macros
  sed -i -E "s/^(Version:[[:space:]]*)[0-9][^[:space:]%}]*/\1${version}/" "$specfile" && echo "$specfile Version updated"

  # Reset Release to 1 (also keeping any possible macros)
  sed -i -E "s/^(Release:[[:space:]]*)[0-9][^[:space:]%}]*/\11/" "$specfile" && echo "$specfile Release updated"
else
  echo "Error: $specfile not found"
fi
